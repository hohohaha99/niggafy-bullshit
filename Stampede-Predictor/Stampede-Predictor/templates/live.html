<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Live Monitoring - CrowdCast Backend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="{{ url_for('static', filename='StampedeAi_Icon.png') }}" type="image/png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --sidebar-bg: #1a1d21;
      --sidebar-width: 240px;
      --bg-body: #0f1114;
      --bg-card: #1a1d21;
      --bg-hover: #22262b;
      --border: #2d3139;
      --accent: #4f8cff;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-1: #f1f5f9;
      --text-2: #94a3b8;
      --text-3: #64748b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-1);
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      position: fixed;
      height: 100vh;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-brand {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-brand img {
      height: 32px;
    }

    .sidebar-brand h1 {
      font-size: 1rem;
      font-weight: 600;
    }

    .sidebar-brand span {
      font-size: 0.65rem;
      background: var(--accent);
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }

    .sidebar-nav {
      padding: 16px 12px;
      flex: 1;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: var(--text-3);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      color: var(--text-2);
      text-decoration: none;
      font-size: 0.875rem;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-1);
    }

    .nav-item.active {
      background: rgba(79, 140, 255, 0.15);
      color: var(--accent);
    }

    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-3);
    }

    .main {
      margin-left: var(--sidebar-width);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .header {
      height: 56px;
      background: var(--sidebar-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .status-ind {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .status-ind.online {
      color: var(--success);
    }

    .status-ind.error {
      color: var(--danger);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.5
      }
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.2
      }
    }

    .content {
      padding: 24px;
      flex: 1;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .page-header p {
      color: var(--text-2);
      font-size: 0.875rem;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      font-size: 1.5rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .stat-icon.normal {
      background: rgba(34, 197, 94, 0.15);
    }

    .stat-icon.warning {
      background: rgba(245, 158, 11, 0.15);
    }

    .stat-icon.critical {
      background: rgba(239, 68, 68, 0.15);
    }

    .stat-info {
      flex: 1;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-3);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-body {
      padding: 20px;
    }

    .video-wrap {
      position: relative;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      aspect-ratio: 16/9;
      max-height: 480px;
    }

    .video-wrap img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .video-overlay {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 8px;
    }

    .video-badge {
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .video-badge.live {
      color: var(--danger);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-size: 0.8rem;
      color: var(--text-2);
    }

    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-hover);
      color: var(--text-1);
      font-size: 0.8rem;
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-hover);
      color: var(--text-1);
      transition: all 0.15s;
      text-decoration: none;
    }

    .btn:hover {
      border-color: var(--accent);
    }

    .btn.muted {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.4);
      color: var(--success);
    }

    .btn:not(.muted) {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
      color: var(--danger);
    }

    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-1);
      font-size: 1.5rem;
      cursor: pointer;
    }

    @media(max-width:768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main {
        margin-left: 0;
      }

      .mobile-toggle {
        display: block;
      }

      .stats-row {
        grid-template-columns: 1fr 1fr;
      }

      .content {
        padding: 16px;
      }
    }
  </style>
</head>

<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand"><img src="{{ url_for('static', filename='StampedeAi_Logo.png') }}" alt="Logo">
      <h1>CrowdCast</h1><span>Backend</span>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-title">Overview</div>
        <a href="{{ url_for('index_route') }}" class="nav-item">üìä Dashboard</a>
        <a href="#" class="nav-item active">üìπ Live Monitoring</a>
      </div>
      <div class="nav-section">
        <div class="nav-title">Analysis</div>
        <a href="{{ url_for('index_route') }}#upload-section" class="nav-item">üì§ Upload Media</a>
      </div>
    </nav>
    <div class="sidebar-footer">¬© 2025 Team Arete</div>
  </aside>
  <main class="main">
    <header class="header">
      <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
      <div class="header-title">Live Monitoring Console</div>
      <div class="status-ind online" id="connection-status"><span class="status-dot"></span>Connecting...</div>
    </header>
    <div class="content">
      <div class="page-header">
        <h2>Real-Time Feed Analysis</h2>
        <p>Monitoring crowd density with live risk assessment</p>
      </div>
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon normal" id="risk-icon">üìä</div>
          <div class="stat-info">
            <div class="stat-label">Current Risk</div>
            <div class="stat-value" id="stampede-chance-heading">Initializing...</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-info">
            <div class="stat-label">Persons</div>
            <div class="stat-value" id="persons-heading">N/A</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">üìπ Live Video Feed</span></div>
        <div class="card-body">
          <div class="video-wrap"><img id="live-video-feed" src="" alt="Live Feed">
            <div class="video-overlay">
              <div class="video-badge live"><span class="status-dot"
                  style="width:6px;height:6px;animation:blink 0.5s infinite"></span>LIVE</div>
              <div class="video-badge" id="camera-label">Camera 0</div>
            </div>
          </div>
          <div class="controls">
            <div class="control-group"><label for="cameraSelect">Camera:</label><select id="cameraSelect">
                <option value="0">Camera 0</option>
                <option value="1">Camera 1</option>
                <option value="2">Camera 2</option>
                <option value="3">Camera 3</option>
              </select></div>
            <button id="muteButton" class="btn">üîá Mute</button>
            <a href="{{ url_for('index_route') }}" class="btn"
              style="background:var(--bg-hover);color:var(--text-2);border-color:var(--border);">‚Üê Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </main>
  <audio id="alertBeep" src="{{ url_for('static', filename='beep.mp3') }}" preload="auto"></audio>
  <script>
    const cameraSelect = document.getElementById('cameraSelect'), videoFeed = document.getElementById('live-video-feed'), chanceH = document.getElementById('stampede-chance-heading'), personsH = document.getElementById('persons-heading'), connStatus = document.getElementById('connection-status'), camLabel = document.getElementById('camera-label'), riskIcon = document.getElementById('risk-icon'), alertAudio = document.getElementById('alertBeep'), muteBtn = document.getElementById('muteButton');
    let isPlaying = false, isMuted = false;
    function updateStream() { const i = cameraSelect.value; videoFeed.src = `{{ url_for('video_feed_route') }}?camera=${i}`; camLabel.textContent = `Camera ${i}`; chanceH.textContent = 'Initializing...'; personsH.textContent = 'N/A'; connStatus.innerHTML = '<span class="status-dot"></span>Connecting...'; connStatus.className = 'status-ind online'; }
    cameraSelect.addEventListener('change', updateStream); document.addEventListener('DOMContentLoaded', updateStream);
    videoFeed.onerror = () => { connStatus.innerHTML = '<span class="status-dot"></span>Feed Error'; connStatus.className = 'status-ind error'; };
    function playAlert() { if (!isPlaying && !isMuted && alertAudio) { isPlaying = true; alertAudio.play().catch(() => { isPlaying = false; }); } }
    if (alertAudio) alertAudio.addEventListener('ended', () => { isPlaying = false; });
    if (muteBtn) muteBtn.addEventListener('click', () => { isMuted = !isMuted; if (isMuted) { muteBtn.innerHTML = 'üîä Unmute'; muteBtn.classList.add('muted'); if (isPlaying) { alertAudio.pause(); alertAudio.currentTime = 0; isPlaying = false; } } else { muteBtn.innerHTML = 'üîá Mute'; muteBtn.classList.remove('muted'); } });
    if (typeof EventSource !== 'undefined') {
      const es = new EventSource("{{ url_for('stream_status_route') }}");
      es.onopen = () => { connStatus.innerHTML = '<span class="status-dot"></span>Connected'; connStatus.className = 'status-ind online'; };
      es.onmessage = (e) => { try { const d = JSON.parse(e.data); let txt = 'Unknown', cls = 'normal', snd = false, ico = 'üìä'; if (d.status) { const s = d.status; if (s.includes('CRITICAL')) { txt = '‚ö†Ô∏è CRITICAL'; cls = 'critical'; snd = true; ico = 'üö®'; } else if (s.includes('Warning')) { txt = '‚ö†Ô∏è High'; cls = 'warning'; snd = true; ico = '‚ö†Ô∏è'; } else if (s.includes('Detected')) { txt = 'üìä Moderate'; cls = 'warning'; } else if (s === 'Normal') { txt = '‚úì Low'; cls = 'normal'; ico = '‚úÖ'; } else if (s.includes('Error')) { txt = '‚ùå Error'; cls = 'critical'; ico = '‚ùå'; } else { txt = s; } } chanceH.textContent = txt; chanceH.style.color = cls === 'critical' ? 'var(--danger)' : cls === 'warning' ? 'var(--warning)' : 'var(--success)'; riskIcon.textContent = ico; riskIcon.className = 'stat-icon ' + cls; personsH.textContent = d.persons !== undefined ? d.persons : 'N/A'; if (snd) playAlert(); } catch (err) { console.error(err); } };
      es.onerror = () => { connStatus.innerHTML = '<span class="status-dot"></span>Disconnected'; connStatus.className = 'status-ind error'; es.close(); };
    }
    document.querySelectorAll('.nav-item').forEach(i => i.addEventListener('click', () => document.getElementById('sidebar').classList.remove('open')));
  </script>
</body>

</html>